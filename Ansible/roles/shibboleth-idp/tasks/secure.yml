---
- name: Create the directory for tomcat certificates
  sudo: yes
  file: path={{ tomcat6_config_path }}/certs/ state=directory owner={{ tomcat6_user }} group={{ tomcat6_group }}

- name: Generate the private key for certificate request
  sudo: yes
  shell: openssl genrsa -des3 -passout pass:password -out my1.key 1024 chdir={{ tomcat6_config_path }} creates={{ tomcat6_config_path }}/my1.key

- name: Strip the passphrase from the key 
  sudo: yes
  shell: openssl rsa -in my1.key -passin pass:password -out my.key chdir={{ tomcat6_config_path }} creates={{ tomcat6_config_path }}/my.key

- name: Create and sign the the new certificate 
  sudo: yes
  shell: openssl req -new -x509 -subj '/C={{ server_country }}/ST={{ server_state }}/L={{ server_location }}/O={{ server_organization }}/CN={{ ansible_hostname }}/' -days 3650 -key my.key -out cert.crt -extensions v3_ca chdir={{ tomcat6_config_path }}  creates={{ tomcat6_config_path }}/cert.crt




- name: Restart tomcat server
  service: name={{ tomcat6_service }} state=restarted
  sudo: yes 
  when: ldap_config.stdout.find('certs/my.key')==-1
  tags: 
    - LDAP
    - config

