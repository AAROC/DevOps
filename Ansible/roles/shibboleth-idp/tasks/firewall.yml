---
- name: Retrieve iptables rules 
  command: iptables -t nat -L 
  register: iptables_rules 
  changed_when: "False"
  sudo: yes 
 

- name: Add port 80 redirect to firewall
  command: iptables -t nat -A PREROUTING -p tcp -m tcp --dport 80 -j DNAT --to-destination {{ idp_host_ip }}:{{ shibboleth_port }}
  sudo: yes 
  when: iptables_rules.stdout.find('dpt:http')==-1 and iptables_rules.stdout.find('dpt:www')==-1 

- name: Add port 443 redirect to firewall
  command: iptables -t nat -A PREROUTING -p tcp -m tcp --dport 443 -j DNAT --to-destination {{ idp_host_ip }}:{{ shibboleth_secure_port }}
  sudo: yes 
  when: iptables_rules.stdout.find('dpt:https')==-1

- name: Save iptable rules
  shell: /sbin/iptables-save > /etc/iptables/rules
  sudo: yes 
  when: ansible_os_family=="Debian" and iptables_rules.stdout.find('dpt:https')==-1

- name: Save iptable rules
  command: service iptables save
  sudo: yes 
  when: ansible_os_family=="RedHat" and iptables_rules.stdout.find('dpt:https')==-1

