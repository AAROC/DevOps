# worker nodes playbook
# this assumes that you've already run the bootstrap role as root.

# since this is to manage the worker nodes, we are also assuming that they are on a local network
# and that you can happily ssh to them as root
---
- hosts: cluster-head-nodes
  connection: local
  tasks:
  - name: Debug host key
    debug:
      msg: "key is {{ ansible_ssh_host_key_rsa_public }}"
    tags:
      - debug

  - name: Put the host key in the worker node public keys
    lineinfile:
      dest: roles/worker-node/vars/public_keys.yml
      line: "public_keys{{':'}} ssh-rsa {{ ansible_ssh_host_key_rsa_public }} ansible@{{ ansible_hostname }}"
      state: present
      create: yes
    delegate_to: localhost
  - name: Ensure that the munge directory is available in the local clone
    file:
      path: roles/worker-node/files/etc/munge
      state: directory
    delegate_to: localhost

- hosts: worker-nodes
  name: Prepare worker nodes for installation
  user: root
  roles:
    - common
    - certificates
    - worker-node
    - umd
    - emi-worker-node
    - yaim
  pre_tasks:
    - name: Pull in the relevant variables
      include_vars: "{{ item }}"
      with_items:
        - roles/common/vars/middleware/IGTF.yml
        - "group_vars/passwords-{{ site_name }}.yml"

    - name: Tell the team
      slack:
        domain: africa-arabia-roc.slack.com
        token: "{{ slack_token }}"
        msg: "About to run the worker-nodes play on {{ inventory_hostname }} at {{ site_name }}"
        channel: "#devopssite"
        username: "Ansible on {{ inventory_hostname }}"
        link_names: 1
        parse: 'full'
      tags:
        - slack
  post_tasks:
    - name: Announce the play via Slack
      slack:
        domain: africa-arabia-roc.slack.com
        token: "{{ slack_token }}"
        msg: "WN deployed at  {{ inventory_hostname }} at {{ site_name }}"
        channel: "#devopssite"
        username: "Ansible on {{ inventory_hostname }}"
        #icon_url: "http://www.example.com/some-image-file.png"
        link_names: 1
        parse: 'full'
      tags:
        - slack
