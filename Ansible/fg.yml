---
# First play - create the containers
# make sure deploy-hosts is set properly in your inventory
# it should have everything necessary to use the Docker container module
# http://docs.ansible.com/ansible/docker_container_module.html

# The db container requires some passwords to be passed at run creation time.
# You should pass these as variables on the command line :
# ansible-container -i <path-to-docker.py> site.yml -e mysql_root_password=<password>
# The playbook will fail unless you pass that var.
- hosts: localhost
  name: Create containers
  connection: local
  # roles:
  #   - docker
  tasks:
  - name: create the db container
    docker_container:
      name: fg_db
      image: "mysql:5.7"
      hostname: fg_db
      exposed_ports: 3306
      env:
        MYSQL_ROOT_PASSWORD="{{ mysql_root_password }}"
      state: started
    register: db_container
  - name:
    wait_for_connection:
  # - name: wait for db to come up
  #   wait_for:
  #     host: db_container.ansible_facts.docker_container.NetworkSettings.IPAddress
  #     port: 3306
  #     timeout: 10
  - name: Create the APIserver container
    docker_container:
      name: fg_api
      image: "centos:7"
      hostname: fg_api
      exposed_ports: 8888
      state: started
      command: ['/bin/sleep', 'infinity']
    register: api_container

  - meta: refresh_inventory

- name: Get them to the python !
  hosts: fg_db
  connection: docker
  gather_facts: no
  tasks:
    - raw: which python || apt-get update &&  apt-get install -y python


- name: Create DB
  hosts: fg_db
  connection: docker
  roles:
    - AAROC.fg-db

- name: Create API Server
  hosts: fg_api
  connection: docker
  roles:
    - AAROC.fgapi
